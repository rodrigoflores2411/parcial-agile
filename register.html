<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

<script src="js/dom-ready.js?v=1"></script>
<script src="js/firebase-config.js?v=13"></script>
<script src="js/api-config.js?v=13"></script>

<script>
  // Inicializa Firebase
  const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(window.FIREBASE_CFG);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // Helpers
  const $ = (id) => document.getElementById(id);

  // --- Autocompletar Nombres/Apellidos por DNI (apiperu) ---
  async function lookupDni(dni){
    if(!/^\d{8}$/.test(dni)) return { ok:false, msg:"El DNI debe tener 8 dígitos." };
    const token = window?.APIPERU?.token;
    const base  = window?.APIPERU?.baseUrl || "https://apiperu.dev/api";
    if(!token) return { ok:false, msg:"Falta configurar js/api-config.js con tu token de apiperu." };

    try{
      const r = await fetch(`${base}/dni/${dni}`, {
        headers: { Authorization: `Bearer ${token}`, Accept: "application/json" }
      });
      if(!r.ok) return { ok:false, msg:`API error ${r.status}` };
      const j = await r.json();
      const d = j.data || {};
      const nombres   = (d.nombres||"").trim();
      const apellidos = [d.apellido_paterno, d.apellido_materno].filter(Boolean).map(s=>String(s).trim()).join(" ");
      if(!nombres && !apellidos) return { ok:false, msg:"El API no devolvió nombres/apellidos." };
      return { ok:true, data:{ dni, nombres, apellidos } };
    }catch(e){ return { ok:false, msg:e.message }; }
  }

  onReady(() => {
    // Autocompletar al escribir 8 dígitos (con debounce)
    let timer = null;
    on("dni", "input", () => {
      clearTimeout(timer);
      timer = setTimeout(async () => {
        const dni = $("dni")?.value.trim();
        if(!/^\d{8}$/.test(dni)) return;
        const msg = $("regMsg"); if(msg){ msg.className="alert"; msg.textContent="Consultando DNI..."; }
        const r = await lookupDni(dni);
        if(!r.ok){ if(msg){ msg.className="alert err"; msg.textContent=r.msg; } return; }
        $("nombres") && ( $("nombres").value = r.data.nombres || "" );
        $("apellidos") && ( $("apellidos").value = r.data.apellidos || "" );
        if(msg){ msg.className="alert ok"; msg.textContent="Datos autocompletados desde apiperu."; }
      }, 500);
    });

    // --- Registro de usuario ---
    on("registerForm", "submit", async (e) => {
      e.preventDefault();
      const email     = $("email")?.value.trim();
      const password  = $("password")?.value;
      const dni       = $("dni")?.value.trim();
      const nombres   = $("nombres")?.value.trim();
      const apellidos = $("apellidos")?.value.trim();
      const telefono  = $("telefono")?.value.trim();
      const msg = $("regMsg");

      try{
        if(!/^\d{8}$/.test(dni)) throw new Error("El DNI debe tener 8 dígitos.");
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection("clients").doc(dni).set({
          dni, nombres, apellidos, telefono,
          createdBy: cred.user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        if(msg){ msg.className="alert ok"; msg.textContent="Cuenta creada y cliente registrado. Ya puedes iniciar sesión."; }
      }catch(err){
        console.error("REGISTER ERROR:", err.code, err.message);
        if(!msg) return;
        msg.className = "alert err";
        if (err.code === "auth/email-already-in-use") {
          msg.innerHTML = `Este correo ya está registrado. <a href="reset.html">Recupera tu contraseña</a> o <a href="index.html">inicia sesión</a>.`;
        } else if (err.code === "auth/weak-password") {
          msg.textContent = "La contraseña es demasiado débil.";
        } else if (err.code === "auth/operation-not-allowed") {
          msg.textContent = "Habilita Email/Password en Firebase → Authentication → Sign-in method.";
        } else if (err.code === "auth/invalid-api-key" || err.code === "auth/invalid-config") {
          msg.textContent = "Revisa js/firebase-config.js (apiKey/authDomain/projectId).";
        } else {
          msg.textContent = err.message || "Ocurrió un error al registrar.";
        }
      }
    });
  });
</script>
